<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi Staff</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

    :root {
      --primary-color: #4A90E2;
      --secondary-color: #F5F7FA;
      --text-color: #333;
      --border-color: #DDD;
      --success-color: #5CB85C;
      --danger-color: #D9534F;
      --shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--secondary-color);
      margin: 0;
      padding: 20px;
      color: var(--text-color);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    header {
      text-align: center;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    header h1 {
      margin: 0;
      color: var(--primary-color);
      font-weight: 700;
    }

    .shift-selector {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 25px;
    }

    .shift-btn {
      padding: 10px 25px;
      border: none;
      background-color: #E0E0E0;
      color: var(--text-color);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
    }

    .shift-btn.active {
      background-color: var(--primary-color);
      color: white;
    }

    .shift-btn:hover:not(.active) {
      background-color: #C0C0C0;
    }

    .shift-container {
      display: none;
    }

    .shift-container.active {
      display: block;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    thead th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
    }

    tbody tr:hover {
      background-color: var(--secondary-color);
    }

    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .checkin-btn {
      background-color: var(--success-color);
      color: white;
    }

    .checkin-btn:hover {
      background-color: #4CAE4C;
    }

    .delete-btn {
      background-color: var(--danger-color);
      color: white;
    }

    .delete-btn:hover {
      background-color: #C9302C;
    }

    .time-display {
      font-weight: 500;
      color: #555;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Sistem Absensi Staff</h1>
    </header>

    <main>
      <nav class="shift-selector">
        <button class="shift-btn active" onclick="showShift('pagi')">Shift Pagi</button>
        <button class="shift-btn" onclick="showShift('siang')">Shift Siang</button>
        <button class="shift-btn" onclick="showShift('malam')">Shift Malam</button>
      </nav>

      <div id="pagi-container" class="shift-container active">
        <h2>Daftar Absensi Shift Pagi</h2>
        <table>
          <thead>
            <tr>
              <th>Nama Staff</th>
              <th>Time</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="pagi-table-body">
            <!-- Data akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>

      <div id="siang-container" class="shift-container">
        <h2>Daftar Absensi Shift Siang</h2>
        <table>
          <thead>
            <tr>
              <th>Nama Staff</th>
              <th>Time</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="siang-table-body">
            <!-- Data akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>

      <div id="malam-container" class="shift-container">
        <h2>Daftar Absensi Shift Malam</h2>
        <table>
          <thead>
            <tr>
              <th>Nama Staff</th>
              <th>Time</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="malam-table-body">
            <!-- Data akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    let allStaffData = {};

    // Fungsi untuk menampilkan shift yang dipilih
    function showShift(shiftName) {
      // Sembunyikan semua container
      document.querySelectorAll('.shift-container').forEach(container => {
        container.classList.remove('active');
      });
      // Hapus class active dari semua tombol
      document.querySelectorAll('.shift-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Tampilkan container yang dipilih
      document.getElementById(`${shiftName}-container`).classList.add('active');
      // Tandai tombol yang dipilih
      event.target.classList.add('active');
    }

    // Fungsi untuk membuat baris tabel
    function createTableRow(staff, shiftKey) {
      const row = document.createElement('tr');
      const nameCell = document.createElement('td');
      const timeCell = document.createElement('td');
      const actionCell = document.createElement('td');

      nameCell.textContent = staff.name;
      timeCell.textContent = staff.time;
      timeCell.className = 'time-display';
      timeCell.id = `time-${shiftKey}-${staff.name.replace(/\s+/g, '-')}`;

      const button = document.createElement('button');
      button.className = 'action-btn';
      button.id = `btn-${shiftKey}-${staff.name.replace(/\s+/g, '-')}`;

      if (staff.time) {
        button.textContent = 'Hapus';
        button.className += ' delete-btn';
        button.onclick = () => handleDelete(shiftKey.toUpperCase(), staff.name);
      } else {
        button.textContent = 'Check-in';
        button.className += ' checkin-btn';
        button.onclick = () => handleCheckIn(shiftKey.toUpperCase(), staff.name);
      }
      
      actionCell.appendChild(button);

      row.appendChild(nameCell);
      row.appendChild(timeCell);
      row.appendChild(actionCell);

      return row;
    }

    // Fungsi untuk mempopulate tabel dengan data
    function populateTables(data) {
      allStaffData = data;
      const shifts = ['pagi', 'siang', 'malam'];

      shifts.forEach(shift => {
        const tableBody = document.getElementById(`${shift}-table-body`);
        tableBody.innerHTML = ''; // Kosongkan tabel sebelum mengisi

        if (data[shift] && data[shift].length > 0) {
          data[shift].forEach(staff => {
            tableBody.appendChild(createTableRow(staff, shift));
          });
        } else {
          tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Tidak ada data staff untuk shift ini.</td></tr>';
        }
      });
    }

    // Handler untuk tombol Check-in
    function handleCheckIn(shift, staffName) {
      const buttonId = `btn-${shift.toLowerCase()}-${staffName.replace(/\s+/g, '-')}`;
      const button = document.getElementById(buttonId);
      button.disabled = true;
      button.textContent = 'Memproses...';

      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            const timeId = `time-${shift.toLowerCase()}-${staffName.replace(/\s+/g, '-')}`;
            const timeCell = document.getElementById(timeId);
            timeCell.textContent = response.time;

            button.textContent = 'Hapus';
            button.className = 'action-btn delete-btn';
            button.onclick = () => handleDelete(shift, staffName);
            button.disabled = false;
          } else {
            alert('Gagal check-in: ' + response.message);
            button.disabled = false;
            button.textContent = 'Check-in';
          }
        })
        .withFailureHandler(error => {
          alert('Terjadi kesalahan. Silakan coba lagi. Error: ' + error.message);
          button.disabled = false;
          button.textContent = 'Check-in';
        })
        .recordCheckIn(shift, staffName);
    }

    // Handler untuk tombol Hapus
    function handleDelete(shift, staffName) {
      if (!confirm(`Apakah Anda yakin ingin menghapus absensi untuk ${staffName}?`)) {
        return;
      }

      const buttonId = `btn-${shift.toLowerCase()}-${staffName.replace(/\s+/g, '-')}`;
      const button = document.getElementById(buttonId);
      button.disabled = true;
      button.textContent = 'Menghapus...';

      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            const timeId = `time-${shift.toLowerCase()}-${staffName.replace(/\s+/g, '-')}`;
            const timeCell = document.getElementById(timeId);
            timeCell.textContent = '';

            button.textContent = 'Check-in';
            button.className = 'action-btn checkin-btn';
            button.onclick = () => handleCheckIn(shift, staffName);
            button.disabled = false;
          } else {
            alert('Gagal menghapus: ' + response.message);
            button.disabled = false;
            button.textContent = 'Hapus';
          }
        })
        .withFailureHandler(error => {
          alert('Terjadi kesalahan. Silakan coba lagi. Error: ' + error.message);
          button.disabled = false;
          button.textContent = 'Hapus';
        })
        .deleteCheckIn(shift, staffName);
    }

    // Panggil fungsi untuk mengambil data saat halaman dimuat
    window.onload = function() {
      google.script.run
        .withSuccessHandler(populateTables)
        .withFailureHandler(error => {
          document.body.innerHTML = `<div class="container loading">Gagal memuat data. Error: ${error.message}</div>`;
        })
        .getStaffAndAttendanceData();
    };
  </script>
</body>
</html>
