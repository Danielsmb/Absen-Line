<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ABSENSI LINE TOGEL</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #8E44AD;
      --primary-light: #d05ce3;
      --primary-dark: #6a0080;
      --secondary: #3498DB;
      --success: #4caf50;
      --danger: #E74C3C;
      --warning: #F39C12;
      --dark: #2C3E50;
      --light: #ECF0F1;
      --gray: #757575;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      line-height: 1.6;
      color: var(--light);
      background-image: url('https://media.linklist.bio/backgrounds/Zq7Qb762Xj6KaUWUSEPXCDpmKLCATryoNbbjK7Er.webp');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, rgba(142, 68, 173, 0.9), rgba(106, 0, 128, 0.9));
      color: white;
      padding: 25px;
      text-align: center;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      position: relative;
      text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      background: rgba(0,0,0,0.2);
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      margin-top: 15px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(44, 62, 80, 0.7);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .stat-card i {
      font-size: 2.5rem;
      margin-bottom: 15px;
      display: block;
    }

    .stat-card h3 {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: rgba(255,255,255,0.9);
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .total-staff .value { color: var(--primary-light); }
    .present .value { color: var(--success); }
    .absent .value { color: var(--danger); }

    .card {
      background: rgba(44, 62, 80, 0.7);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h2 i {
      color: var(--primary-light);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      font-size: 1rem;
      background: rgba(0,0,0,0.3);
      color: white;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.3);
    }

    .btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 14px 25px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--primary-light), var(--primary));
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      background: var(--gray);
    }

    .btn i {
      font-size: 1.2rem;
    }

    .table-responsive {
      overflow-x: auto;
      border-radius: 10px;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(44, 62, 80, 0.7);
      border-radius: 10px;
      overflow: hidden;
      backdrop-filter: blur(5px);
    }

    th {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      text-align: center;
      color: rgba(255,255,255,0.9);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255,255,255,0.03);
    }

    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      min-width: 100px;
    }

    .present {
      background: rgba(76, 175, 80, 0.15);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .absent {
      background: rgba(244, 67, 54, 0.15);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .time-format {
      font-family: 'Roboto Mono', monospace;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
      color: var(--secondary);
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
      transition: opacity 0.3s;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    .small-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      z-index: 1001;
      opacity: 0;
      transition: all 0.3s;
      font-weight: 500;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 90%;
      backdrop-filter: blur(10px);
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px);
    }

    .toast.success { border-left: 5px solid var(--success); }
    .toast.error { border-left: 5px solid var(--danger); }
    .toast.warning { border-left: 5px solid var(--warning); }
    .toast.info { border-left: 5px solid var(--secondary); }

    .toast i { font-size: 1.2rem; }

    .highlight-change {
      animation: highlight-fade 2s ease-out;
    }

    @keyframes highlight-fade {
      0% { background-color: rgba(46, 204, 113, 0.3); }
      100% { background-color: transparent; }
    }

    .refresh-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .refresh-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(180deg);
    }

    .reset-btn {
      background: linear-gradient(135deg, var(--danger), #c0392b);
      margin-top: 10px;
    }

    .reset-btn:hover {
      background: linear-gradient(135deg, #e74c3c, var(--danger));
    }

    .sync-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .sync-indicator.syncing {
      animation: spin 1s linear infinite;
    }

    .sync-indicator.synced {
      color: var(--success);
    }

    .sync-indicator.error {
      color: var(--danger);
    }

    .last-sync {
      position: absolute;
      bottom: 10px;
      right: 20px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
    }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      .header h1 { font-size: 1.8rem; }
      .dashboard { grid-template-columns: 1fr; }
      .card { padding: 20px; }
      th, td { padding: 10px 8px; font-size: 0.8rem; }
      .mobile-hidden { display: none; }
      .last-sync { display: none; }
    }

    @keyframes pop {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary-light); }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="sync-indicator" id="syncIndicator" title="Sinkronisasi Data">
        <i class="fas fa-sync-alt"></i>
      </button>
      <button class="refresh-btn" id="refreshBtn" title="Refresh Data">
        <i class="fas fa-redo"></i>
      </button>
      <h1><i class="fas fa-fingerprint"></i> ABSENSI LINE TOGEL</h1>
      <p>Sistem Absensi Digital</p>
      <div class="header-info">
        <span id="currentDate"><i class="far fa-calendar-alt"></i> Loading...</span>
        <span id="currentTime"><i class="far fa-clock"></i> Loading...</span>
      </div>
      <div class="last-sync" id="lastSync">Terakhir sinkronisasi: -</div>
    </header>

    <div class="dashboard">
      <div class="stat-card total-staff animate-pop" style="animation-delay: 0.1s">
        <i class="fas fa-users"></i>
        <h3>Total Staff</h3>
        <div class="value" id="totalStaff">0</div>
      </div>
      <div class="stat-card present animate-pop" style="animation-delay: 0.2s">
        <i class="fas fa-user-check"></i>
        <h3>Sudah Absen</h3>
        <div class="value" id="presentCount">0</div>
      </div>
      <div class="stat-card absent animate-pop" style="animation-delay: 0.3s">
        <i class="fas fa-user-clock"></i>
        <h3>Belum Absen</h3>
        <div class="value" id="absentCount">0</div>
      </div>
    </div>

    <div class="card animate-pop" style="animation-delay: 0.4s">
      <h2><i class="fas fa-edit"></i> Form Absensi</h2>
      <div class="form-group">
        <label for="staffSelect"><i class="fas fa-user-tag"></i> Pilih Nama Anda</label>
        <select id="staffSelect" class="form-control">
          <option value="">-- Pilih Nama Anda --</option>
        </select>
      </div>
      <button class="btn" id="submitBtn">
        <i class="fas fa-paper-plane"></i> ABSEN
      </button>
      <button class="btn reset-btn" id="resetBtn">
        <i class="fas fa-redo"></i> RESET DATA ABSENSI
      </button>
    </div>

    <div class="card animate-pop" style="animation-delay: 0.5s">
      <h2><i class="fas fa-list-ol"></i> Rekap Absensi Hari Ini</h2>
      <div class="form-group">
        <label for="staffSearch"><i class="fas fa-search"></i> Cari Data Staff</label>
        <input type="text" id="staffSearch" class="form-control" placeholder="Ketik untuk mencari...">
      </div>
      <div class="table-responsive">
        <table id="attendanceTable">
          <thead id="tableHead">
            <tr>
              <td colspan="5" style="text-align: center; color: var(--gray);">
                <div class="small-spinner"></div>
              </td>
            </tr>
          </thead>
          <tbody id="attendanceBody">
            <tr>
              <td colspan="5" style="text-align: center; color: var(--gray);">
                Menunggu data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Konfigurasi Google Sheets
    const SPREADSHEET_ID = '1LFwBDu0JS4VmYP7vtQpLgF7Roa0pWiEAb7jJlahze88';
    const SHEET_GID = '511063901';
    const API_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
    
    // Ganti dengan URL Web App dari Google Apps Script Anda
    // GANTI BAGIAN INI DENGAN URL WEB APP ANDA
    const SCRIPT_URL = 'GANTI_DENGAN_URL_WEB_APP_ANDA'; // <--- PASTIKAN ANDA MENGUBAH INI

    // Variabel global
    let staffData = [];
    let sheetHeaders = [];
    let isProcessing = false;
    let lastResetDate = null;
    let autoRefreshInterval = null;
    let lastSyncTime = null;

    // Asumsi nama kolom untuk fungsi spesifik
    let idHeader, nameHeader, statusHeader, timeHeader;

    // Cache elemen DOM
    const elements = {
      loading: document.getElementById('loading'),
      toast: document.getElementById('toast'),
      staffSelect: document.getElementById('staffSelect'),
      submitBtn: document.getElementById('submitBtn'),
      resetBtn: document.getElementById('resetBtn'),
      attendanceBody: document.getElementById('attendanceBody'),
      tableHead: document.getElementById('tableHead'),
      totalStaff: document.getElementById('totalStaff'),
      presentCount: document.getElementById('presentCount'),
      absentCount: document.getElementById('absentCount'),
      staffSearch: document.getElementById('staffSearch'),
      currentDate: document.getElementById('currentDate'),
      currentTime: document.getElementById('currentTime'),
      refreshBtn: document.getElementById('refreshBtn'),
      syncIndicator: document.getElementById('syncIndicator'),
      lastSync: document.getElementById('lastSync')
    };

    // Inisialisasi aplikasi
    document.addEventListener('DOMContentLoaded', function() {
      updateClock();
      setInterval(updateClock, 1000);
      elements.submitBtn.addEventListener('click', markAttendance);
      elements.resetBtn.addEventListener('click', resetAttendance);
      elements.staffSearch.addEventListener('input', filterStaff);
      elements.refreshBtn.addEventListener('click', () => {
        loadInitialData();
        showToast('Data sedang dimuat ulang...', 'info');
      });
      
      // Periksa reset setiap menit
      setInterval(checkForMidnightReset, 60000);
      
      // Auto refresh setiap 30 detik untuk menjaga sinkronisasi
      autoRefreshInterval = setInterval(() => {
        loadInitialData(true); // Refresh diam-diam
      }, 30000);
      
      loadInitialData();
    });

    // Fungsi untuk update jam dan tanggal
    function updateClock() {
      const now = new Date();
      elements.currentDate.innerHTML = `<i class="far fa-calendar-alt"></i> ${now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      elements.currentTime.innerHTML = `<i class="far fa-clock"></i> ${hours}:${minutes}:${seconds} WIB`;
    }

    // Fungsi untuk memeriksa apakah sudah lewat tengah malam
    function checkForMidnightReset() {
      const now = new Date();
      const today = now.toDateString();
      
      if (lastResetDate !== today && now.getHours() === 0 && now.getMinutes() < 5) {
        resetAttendance(true);
        lastResetDate = today;
      }
    }

    // Fungsi utama untuk memuat data dari Google Sheets dengan logging yang lebih baik
    async function loadInitialData(isSilent = false) {
      console.log("loadInitialData called. isSilent:", isSilent);
      if (!isSilent) {
        showLoading(true);
        setSyncStatus('syncing');
      }
      
      try {
        console.log("Attempting to fetch CSV from:", API_URL);
        const response = await fetch(API_URL);
        console.log("Fetch response received. Status:", response.status, response.statusText);

        if (!response.ok) {
          console.error("Fetch failed. Response:", response);
          throw new Error(`Gagal mengambil data dari Google Sheets. Status: ${response.status} ${response.statusText}`);
        }
        
        const csvData = await response.text();
        console.log("CSV data received. Length:", csvData.length);
        console.log("First 200 chars of CSV:", csvData.substring(0, 200));
        
        if (csvData.trim() === '') {
            throw new Error("Data CSV kosong. Pastikan sheet memiliki data.");
        }
        
        const parsedData = parseCSV(csvData);
        console.log("Parsed data:", parsedData);

        if (parsedData.headers.length === 0 || parsedData.data.length === 0) {
            throw new Error("Gagal mem-parsing CSV atau data tidak valid.");
        }

        sheetHeaders = parsedData.headers;
        staffData = parsedData.data;

        idHeader = sheetHeaders[0];
        nameHeader = sheetHeaders[1];
        statusHeader = sheetHeaders[3];
        timeHeader = sheetHeaders[4];
        
        console.log("Headers identified:", { idHeader, nameHeader, statusHeader, timeHeader });

        renderTable();
        renderStaffSelect();
        updateDashboard();
        
        lastSyncTime = new Date();
        updateLastSyncTime();
        
        if (!isSilent) {
          showLoading(false);
          animateElements();
          showToast('Data berhasil dimuat dari Google Sheets', 'success');
          setSyncStatus('synced');
        }
      } catch (error) {
        console.error("!!! ERROR in loadInitialData !!!", error);
        if (!isSilent) {
          showLoading(false);
          showToast(`Gagal memuat data: ${error.message}`, 'error');
          setSyncStatus('error');
        }
        // Jangan loadLocalData() agar kita tahu ada masalah
      }
    }

    // Fungsi untuk parsing CSV secara dinamis
    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim() !== '');
      if (lines.length === 0) return { headers: [], data: [] };

      const headers = lines[0].split(',').map(header => header.trim());
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(value => value.trim());
        if (values.length === headers.length) {
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index];
          });
          data.push(row);
        }
      }
      return { headers, data };
    }
    
    function animateElements() {
      const cards = document.querySelectorAll('.card, .stat-card');
      cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-pop');
      });
    }

    // Render tabel absensi secara dinamis
    function renderTable(data = staffData) {
      const thead = elements.tableHead;
      const tbody = elements.attendanceBody;

      thead.innerHTML = `<tr>${sheetHeaders.map(header => `<th>${header}</th>`).join('')}</tr>`;

      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${sheetHeaders.length}" style="text-align: center; color: var(--gray);"><i class="fas fa-info-circle"></i> Tidak ada data</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      data.forEach((staff, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.05}s`;
        row.classList.add('animate-pop');
        
        let cellsHtml = '';
        sheetHeaders.forEach(header => {
          let cellContent = staff[header] || '-';
          let cellClass = '';

          if (header === statusHeader) {
            const statusClass = staff[header] === 'Sudah Absen' ? 'present' : 'absent';
            const icon = staff[header] === 'Sudah Absen' ? 'fa-check' : 'fa-clock';
            cellContent = `<span class="status ${statusClass}">${staff[header]} <i class="fas ${icon}"></i></span>`;
          } else if (header === timeHeader) {
            cellClass = 'time-format';
          }
          
          cellsHtml += `<td class="${cellClass}">${cellContent}</td>`;
        });

        row.innerHTML = cellsHtml;
        tbody.appendChild(row);
      });
    }

    // Render dropdown staff
    function renderStaffSelect() {
      const select = elements.staffSelect;
      select.innerHTML = '<option value="">-- Pilih Nama Anda --</option>';
      
      staffData.forEach(staff => {
        const option = document.createElement('option');
        option.value = staff[idHeader];
        option.textContent = staff[nameHeader];
        if (staff[statusHeader] === 'Belum Absen') {
          option.style.color = '#4caf50';
          option.style.fontWeight = '500';
        }
        select.appendChild(option);
      });
    }

    // Filter staff
    function filterStaff() {
      const term = elements.staffSearch.value.toLowerCase().trim();
      if (!term) {
        renderTable();
        return;
      }
      const filtered = staffData.filter(staff => {
        return Object.values(staff).some(value => 
          value.toLowerCase().includes(term)
        );
      });
      renderTable(filtered);
    }

    // Update dashboard statistik
    function updateDashboard() {
      const presentCount = staffData.filter(staff => staff[statusHeader] === 'Sudah Absen').length;
      const absentCount = staffData.length - presentCount;

      animateCounter(elements.totalStaff, staffData.length);
      animateCounter(elements.presentCount, presentCount);
      animateCounter(elements.absentCount, absentCount);
    }

    function animateCounter(element, target) {
      const current = parseInt(element.textContent) || 0;
      if (current === target) return;
      const increment = target > current ? 1 : -1;
      let currentValue = current;
      const timer = setInterval(() => {
        currentValue += increment;
        element.textContent = currentValue;
        if (currentValue === target) clearInterval(timer);
      }, 30);
    }

    // Fungsi untuk mencatat absensi
    async function markAttendance() {
      if (isProcessing) return;
      const selectedOption = elements.staffSelect.options[elements.staffSelect.selectedIndex];
      const staffId = selectedOption.value?.trim();
      const staffName = selectedOption.text;
      
      if (!staffId) {
        showToast('⚠️ Silakan pilih nama Anda terlebih dahulu!', 'warning');
        elements.staffSelect.focus();
        return;
      }

      const staff = staffData.find(s => s[idHeader] === staffId);
      if (staff[statusHeader] === 'Sudah Absen') {
        showToast('⚠️ Anda sudah absen hari ini!', 'warning');
        return;
      }

      isProcessing = true;
      elements.submitBtn.disabled = true;
      elements.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SEDANG ABSEN...';

      const now = new Date();
      const waktuAbsen = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            function: "updateAttendance", staffId: staffId, status: "Sudah Absen", time: waktuAbsen
          }),
          mode: 'no-cors'
        });
        
        const staffIndex = staffData.findIndex(s => s[idHeader] === staffId);
        if (staffIndex !== -1) {
          staffData[staffIndex][statusHeader] = 'Sudah Absen';
          staffData[staffIndex][timeHeader] = waktuAbsen;
        }
        
        renderTable();
        updateDashboard();
        renderStaffSelect();
        
        showToast(`Absen berhasil! ${staffName} - ${waktuAbsen}`, 'success');
        
        setTimeout(() => { loadInitialData(true); }, 2000);
      } catch (error) {
        console.error('Error marking attendance:', error);
        showToast('Terjadi kesalahan saat menyimpan data. Silakan coba lagi.', 'error');
      } finally {
        isProcessing = false;
        resetSubmitButton();
      }
    }

    // Fungsi untuk mereset data absensi
    async function resetAttendance(isAutomatic = false) {
      if (!isAutomatic) {
        if (!confirm('Apakah Anda yakin ingin mereset semua data absensi?')) return;
      }
      
      showLoading(true);
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ function: "resetAttendance" }),
          mode: 'no-cors'
        });
        
        staffData.forEach(staff => {
          staff[statusHeader] = 'Belum Absen';
          staff[timeHeader] = '-';
        });
        
        renderTable();
        updateDashboard();
        renderStaffSelect();
        
        if (isAutomatic) {
          showToast('Data absensi telah direset otomatis', 'info');
        } else {
          showToast('Data absensi berhasil direset', 'success');
        }
        
        setTimeout(() => { loadInitialData(true); }, 2000);
      } catch (error) {
        console.error('Error resetting attendance:', error);
        showToast('Terjadi kesalahan saat mereset data. Silakan coba lagi.', 'error');
      } finally {
        showLoading(false);
      }
    }

    function setSyncStatus(status) {
      const indicator = elements.syncIndicator;
      indicator.className = 'sync-indicator';
      
      if (status === 'syncing') {
        indicator.classList.add('syncing');
        indicator.title = 'Sedang sinkronisasi...';
      } else if (status === 'synced') {
        indicator.classList.add('synced');
        indicator.title = 'Data tersinkronisasi';
      } else if (status === 'error') {
        indicator.classList.add('error');
        indicator.title = 'Gagal sinkronisasi';
      }
    }

    function updateLastSyncTime() {
      if (lastSyncTime) {
        const hours = String(lastSyncTime.getHours()).padStart(2, '0');
        const minutes = String(lastSyncTime.getMinutes()).padStart(2, '0');
        const seconds = String(lastSyncTime.getSeconds()).padStart(2, '0');
        elements.lastSync.textContent = `Terakhir sinkronisasi: ${hours}:${minutes}:${seconds}`;
      }
    }

    function resetSubmitButton() {
      elements.submitBtn.disabled = false;
      elements.submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ABSEN';
    }

    function showLoading(show) {
      elements.loading.style.display = show ? 'flex' : 'none';
    }

    function showToast(message, type = 'success', duration = 3000) {
      const toast = elements.toast;
      const iconMap = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
      toast.innerHTML = `<i class="fas ${iconMap[type] || 'fa-info-circle'}"></i> ${message}`;
      toast.className = `toast ${type}`;
      toast.classList.add('show');

      if (toast.timeoutId) clearTimeout(toast.timeoutId);
      toast.timeoutId = setTimeout(() => toast.classList.remove('show'), duration);
    }
  </script>
</body>
</html>
