<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ABSENSI LINE TOGEL</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #8E44AD;
      --primary-light: #d05ce3;
      --primary-dark: #6a0080;
      --secondary: #3498DB;
      --success: #4caf50;
      --danger: #E74C3C;
      --warning: #F39C12;
      --dark: #2C3E50;
      --light: #ECF0F1;
      --gray: #757575;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      line-height: 1.6;
      color: var(--light);
      background-image: url('https://media.linklist.bio/backgrounds/Zq7Qb762Xj6KaUWUSEPXCDpmKLCATryoNbbjK7Er.webp');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, rgba(142, 68, 173, 0.9), rgba(106, 0, 128, 0.9));
      color: white;
      padding: 25px;
      text-align: center;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      position: relative;
      text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      background: rgba(0,0,0,0.2);
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      margin-top: 15px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(44, 62, 80, 0.7);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .stat-card i {
      font-size: 2.5rem;
      margin-bottom: 15px;
      display: block;
    }

    .stat-card h3 {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: rgba(255,255,255,0.9);
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .total-staff .value { color: var(--primary-light); }
    .present .value { color: var(--success); }
    .absent .value { color: var(--danger); }

    .card {
      background: rgba(44, 62, 80, 0.7);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h2 i {
      color: var(--primary-light);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      font-size: 1rem;
      background: rgba(0,0,0,0.3);
      color: white;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.3);
    }

    .btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 14px 25px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--primary-light), var(--primary));
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      background: var(--gray);
    }

    .btn i {
      font-size: 1.2rem;
    }

    .table-responsive {
      overflow-x: auto;
      border-radius: 10px;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(44, 62, 80, 0.7);
      border-radius: 10px;
      overflow: hidden;
      backdrop-filter: blur(5px);
    }

    th {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      text-align: center;
      color: rgba(255,255,255,0.9);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255,255,255,0.03);
    }

    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      min-width: 100px;
    }

    .present {
      background: rgba(76, 175, 80, 0.15);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .absent {
      background: rgba(244, 67, 54, 0.15);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .time-format {
      font-family: 'Roboto Mono', monospace;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
      color: var(--secondary);
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
      transition: opacity 0.3s;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    .small-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      z-index: 1001;
      opacity: 0;
      transition: all 0.3s;
      font-weight: 500;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 90%;
      backdrop-filter: blur(10px);
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px);
    }

    .toast.success {
      border-left: 5px solid var(--success);
    }

    .toast.error {
      border-left: 5px solid var(--danger);
    }

    .toast.warning {
      border-left: 5px solid var(--warning);
    }

    .toast.info {
      border-left: 5px solid var(--secondary);
    }

    .toast i {
      font-size: 1.2rem;
    }

    .highlight-change {
      animation: highlight-fade 2s ease-out;
    }

    @keyframes highlight-fade {
      0% { background-color: rgba(46, 204, 113, 0.3); }
      100% { background-color: transparent; }
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      .header h1 {
        font-size: 1.8rem;
      }
      .dashboard {
        grid-template-columns: 1fr;
      }
      .card {
        padding: 20px;
      }
      th, td {
        padding: 10px 8px;
        font-size: 0.8rem;
      }
      .mobile-hidden {
        display: none;
      }
    }

    @keyframes pop {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-light);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-fingerprint"></i> ABSENSI LINE TOGEL</h1>
      <p>Sistem Absensi Digital</p>
      <div class="header-info">
        <span id="currentDate"><i class="far fa-calendar-alt"></i> Loading...</span>
        <span id="currentTime"><i class="far fa-clock"></i> Loading...</span>
      </div>
    </header>

    <div class="dashboard">
      <div class="stat-card total-staff animate-pop" style="animation-delay: 0.1s">
        <i class="fas fa-users"></i>
        <h3>Total Staff</h3>
        <div class="value" id="totalStaff">0</div>
      </div>
      <div class="stat-card present animate-pop" style="animation-delay: 0.2s">
        <i class="fas fa-user-check"></i>
        <h3>Sudah Absen</h3>
        <div class="value" id="presentCount">0</div>
      </div>
      <div class="stat-card absent animate-pop" style="animation-delay: 0.3s">
        <i class="fas fa-user-clock"></i>
        <h3>Belum Absen</h3>
        <div class="value" id="absentCount">0</div>
      </div>
    </div>

    <div class="card animate-pop" style="animation-delay: 0.4s">
      <h2><i class="fas fa-edit"></i> Form Absensi</h2>
      <div class="form-group">
        <label for="staffSelect"><i class="fas fa-user-tag"></i> Pilih Nama Anda</label>
        <select id="staffSelect" class="form-control">
          <option value=""><div class="small-spinner"></div></option>
        </select>
      </div>
      <button class="btn" id="submitBtn">
        <i class="fas fa-paper-plane"></i> ABSEN
      </button>
    </div>

    <div class="card animate-pop" style="animation-delay: 0.5s">
      <h2><i class="fas fa-list-ol"></i> Rekap Absensi Hari Ini</h2>
      <div class="form-group">
        <label for="staffSearch"><i class="fas fa-search"></i> Cari Data Staff</label>
        <input type="text" id="staffSearch" class="form-control" placeholder="Ketik nama atau jabatan...">
      </div>
      <div class="table-responsive">
        <table id="attendanceTable">
          <thead>
            <tr>
              <th class="mobile-hidden">ID</th>
              <th>Nama</th>
              <th class="mobile-hidden">Jabatan</th>
              <th>Status</th>
              <th>Waktu Absen</th>
            </tr>
          </thead>
          <tbody id="attendanceBody">
            <tr>
              <td colspan="5" style="text-align: center;">
                <div class="small-spinner"></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Variabel global
    let staffData = [];
    let isProcessing = false;
    let dataVersion = null;
    let lastUpdated = null;

    // Cache elemen DOM
    const elements = {
      loading: document.getElementById('loading'),
      toast: document.getElementById('toast'),
      staffSelect: document.getElementById('staffSelect'),
      submitBtn: document.getElementById('submitBtn'),
      attendanceBody: document.getElementById('attendanceBody'),
      totalStaff: document.getElementById('totalStaff'),
      presentCount: document.getElementById('presentCount'),
      absentCount: document.getElementById('absentCount'),
      staffSearch: document.getElementById('staffSearch'),
      currentDate: document.getElementById('currentDate'),
      currentTime: document.getElementById('currentTime')
    };

    // Inisialisasi aplikasi
    document.addEventListener('DOMContentLoaded', function() {
      // Hindari cache dengan menambahkan timestamp
      const links = document.querySelectorAll('link[rel="stylesheet"]');
      links.forEach(link => {
        const href = link.getAttribute('href');
        if (href) {
          link.setAttribute('href', href + '?v=' + Date.now());
        }
      });
      
      updateClock();
      setInterval(updateClock, 1000);
      elements.submitBtn.addEventListener('click', markAttendance);
      elements.staffSearch.addEventListener('input', filterStaff);
      loadInitialData();
      
      // Tambahkan interval untuk mengecek update data setiap 30 detik
      setInterval(checkForUpdates, 30000);
    });

    // Fungsi untuk update jam dan tanggal
    function updateClock() {
      const now = new Date();
      elements.currentDate.innerHTML =
        `<i class="far fa-calendar-alt"></i> ${now.toLocaleDateString('id-ID', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}`;
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      elements.currentTime.innerHTML =
        `<i class="far fa-clock"></i> ${hours}:${minutes}:${seconds} WIB`;
    }

    // Fungsi untuk mengecek update data
    function checkForUpdates() {
      google.script.run
        .withSuccessHandler(response => {
          if (response && response.version !== dataVersion) {
            showToast('⚡ Data diperbarui, memuat ulang...', 'info');
            setTimeout(loadInitialData, 1000);
          }
        })
        .withFailureHandler(console.error)
        .getDataVersion();
    }

    // Fungsi utama untuk memuat data
    function loadInitialData() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(handleDataLoadSuccess)
        .withFailureHandler(handleDataLoadError)
        .getStaffData(dataVersion);
    }

    function handleDataLoadSuccess(response) {
      // Jika tidak ada data baru
      if (response === null) {
        showLoading(false);
        return;
      }
      
      // Jika ada data baru
      const data = response.data;
      dataVersion = response.version;
      lastUpdated = response.lastUpdated;
      
      staffData = data.map(staff => {
        if (staff.waktu && typeof staff.waktu === 'string' && staff.waktu.includes('T')) {
          try {
            const dateObj = new Date(staff.waktu);
            if (!isNaN(dateObj.getTime())) {
              staff.waktu = formatTimeFromDate(dateObj);
            }
          } catch (e) {
            console.error('Error formatting waktu:', e);
          }
        }
        return staff;
      });
      
      renderStaffSelect();
      renderTable();
      updateDashboard();
      showLoading(false);
      animateElements();
    }

    function animateElements() {
      const cards = document.querySelectorAll('.card, .stat-card');
      cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-pop');
      });
    }

    function handleDataLoadError(error) {
      console.error('Gagal memuat data:', error);
      elements.attendanceBody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center;">
            <div class="small-spinner"></div>
          </td>
        </tr>
      `;
      setTimeout(loadInitialData, 3000);
    }

    // Helper untuk format waktu dari Date object
    function formatTimeFromDate(date) {
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    // Render dropdown staff in sheet order
    function renderStaffSelect() {
      const select = elements.staffSelect;
      select.innerHTML = '<option value=""><div class="small-spinner"></div></option>';
      
      // Jika data sudah dimuat
      if (staffData.length > 0) {
        select.innerHTML = '<option value="">-- Pilih Nama Anda --</option>';
        
        staffData.forEach(staff => {
          const option = document.createElement('option');
          option.value = staff.id;
          option.textContent = `${staff.nama} (${staff.jabatan || 'Tanpa Jabatan'})`;
          if (staff.status === 'Belum Absen') {
            option.style.color = '#4caf50';
            option.style.fontWeight = '500';
          }
          select.appendChild(option);
        });
      }
    }

    // Render tabel absensi sesuai urutan sheet
    function renderTable(data = staffData) {
      const tbody = elements.attendanceBody;
      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--gray);">
              <i class="fas fa-info-circle"></i> Tidak ada data absensi
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = '';
      data.forEach((staff, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.05}s`;
        row.classList.add('animate-pop');
        let waktuDisplay = staff.waktu || '-';
        if (waktuDisplay.includes('T')) {
          try {
            const dateObj = new Date(waktuDisplay);
            if (!isNaN(dateObj.getTime())) {
              waktuDisplay = formatTimeFromDate(dateObj);
            }
          } catch (e) {
            console.error('Error formatting waktu:', e);
          }
        }
        row.innerHTML = `
          <td class="mobile-hidden">${staff.id}</td>
          <td>${staff.nama}</td>
          <td class="mobile-hidden">${staff.jabatan || '-'}</td>
          <td><span class="status ${staff.status === 'Sudah Absen' ? 'present' : 'absent'}">
            ${staff.status} <i class="fas ${staff.status === 'Sudah Absen' ? 'fa-check' : 'fa-clock'}"></i>
          </span></td>
          <td class="time-format">${waktuDisplay}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Filter staff dengan tetap mempertahankan urutan asli
    function filterStaff() {
      const term = elements.staffSearch.value.toLowerCase().trim();
      if (!term) {
        renderTable();
        return;
      }
      const filtered = staffData.filter(staff =>
        staff.nama.toLowerCase().includes(term) ||
        (staff.jabatan && staff.jabatan.toLowerCase().includes(term)) ||
        staff.id.toLowerCase().includes(term)
      );
      renderTable(filtered);
    }

    // Update dashboard statistik
    function updateDashboard() {
      const presentCount = staffData.filter(staff => staff.status === 'Sudah Absen').length;
      const absentCount = staffData.length - presentCount;

      elements.totalStaff.textContent = staffData.length;
      elements.presentCount.textContent = presentCount;
      elements.absentCount.textContent = absentCount;
      animateCounter(elements.totalStaff, staffData.length);
      animateCounter(elements.presentCount, presentCount);
      animateCounter(elements.absentCount, absentCount);
    }

    function animateCounter(element, target) {
      const current = parseInt(element.textContent);
      if (current === target) return;
      const increment = target > current ? 1 : -1;
      let currentValue = current;
      const timer = setInterval(() => {
        currentValue += increment;
        element.textContent = currentValue;
        if (currentValue === target) {
          clearInterval(timer);
        }
      }, 30);
    }

    // Fungsi untuk mencatat absensi
    async function markAttendance() {
      if (isProcessing) return;
      const selectedOption = elements.staffSelect.options[elements.staffSelect.selectedIndex];
      const staffId = selectedOption.value?.trim();
      const staffName = selectedOption.text.split(' (')[0];
      if (!staffId) {
        showToast('⚠️ Silakan pilih nama Anda terlebih dahulu!', 'warning');
        elements.staffSelect.focus();
        return;
      }

      isProcessing = true;
      elements.submitBtn.disabled = true;
      elements.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SEDANG ABSEN...';

      try {
        const response = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .markAttendance(staffId);
        });

        if (response.success) {
          showToast(`Absen berhasil! ${staffName} - ${response.waktu}`, 'success');
          // Dapatkan data terbaru untuk staff ini saja
          const updatedStaff = await new Promise((resolve) => {
            google.script.run
              .withSuccessHandler(resolve)
              .getUpdatedStaffData(staffId);
          });
          // Update data di tabel tanpa refresh seluruh halaman
          updateStaffRow(updatedStaff);
          updateDashboardStats();
        } else {
          showToast(`⚠️ ${response.message}`, response.alreadyMarked ? 'warning' : 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('❌ Gagal terhubung ke server', 'error');
      } finally {
        isProcessing = false;
        resetSubmitButton();
      }
    }

    function updateStaffRow(updatedStaff) {
      if (!updatedStaff) return;
      const rows = elements.attendanceBody.querySelectorAll('tr');
      for (let row of rows) {
        const rowId = row.cells[0]?.textContent.trim().toLowerCase();
        if (rowId === updatedStaff.id.toLowerCase()) {
          let waktuDisplay = updatedStaff.waktu || '-';
          if (waktuDisplay.includes('T')) {
            try {
              const dateObj = new Date(waktuDisplay);
              if (!isNaN(dateObj.getTime())) {
                waktuDisplay = formatTimeFromDate(dateObj);
              }
            } catch (e) {
              console.error('Error formatting waktu:', e);
            }
          }
          row.innerHTML = `
            <td class="mobile-hidden">${updatedStaff.id}</td>
            <td>${updatedStaff.nama}</td>
            <td class="mobile-hidden">${updatedStaff.jabatan || '-'}</td>
            <td><span class="status ${updatedStaff.status === 'Sudah Absen' ? 'present' : 'absent'}">
              ${updatedStaff.status} <i class="fas ${updatedStaff.status === 'Sudah Absen' ? 'fa-check' : 'fa-clock'}"></i>
            </span></td>
            <td class="time-format">${waktuDisplay}</td>
          `;
          row.classList.add('highlight-change');
          setTimeout(() => row.classList.remove('highlight-change'), 2000);
          break;
        }
      }
    }

    function updateDashboardStats() {
      const presentCount = document.querySelectorAll('.status.present').length;
      const totalRows = elements.attendanceBody.querySelectorAll('tr').length;
      const absentCount = totalRows - presentCount;

      animateCounter(elements.presentCount, presentCount);
      animateCounter(elements.absentCount, absentCount);
    }

    function resetSubmitButton() {
      elements.submitBtn.disabled = false;
      elements.submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ABSEN';
    }

    function showLoading(show) {
      if (show) {
        elements.loading.style.display = 'flex';
      } else {
        elements.loading.style.opacity = '0';
        setTimeout(() => {
          elements.loading.style.display = 'none';
          elements.loading.style.opacity = '1';
        }, 300);
      }
    }

    function showToast(message, type = 'success', duration = 3000) {
      const toast = elements.toast;
      const icon = type === 'success' ? 'fa-check-circle' :
        type === 'error' ? 'fa-exclamation-circle' :
        type === 'warning' ? 'fa-exclamation-triangle' :
        type === 'info' ? 'fa-bolt' : 'fa-info-circle';
      toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
      toast.className = `toast ${type}`;
      toast.classList.add('show');

      if (toast.timeoutId) clearTimeout(toast.timeoutId);
      toast.timeoutId = setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }
  </script>

  <? // Server-side Google Apps Script code ?>
  <?
  /**
  * Absensi Line Togel - Google Apps Script
  * Versi 2.0
  * Dengan fitur auto reset harian
  */

  const CONFIG = {
    SPREADSHEET_ID: '1LFwBDu0JS4VmYP7vtQpLgF7Roa0pWiEAb7jJlahze88',
    SHEET_NAME: 'NAMA STAFF',
    TIMEZONE: 'Asia/Bangkok',
    DATE_FORMAT: 'HH:mm:ss',
    COLUMNS: {
      ID: 1,
      NAMA: 2,
      JABATAN: 3,
      STATUS: 4,
      WAKTU: 5
    },
    RESET_HOUR: 0 // Jam 00:00 (midnight) waktu Bangkok
  };

  function doGet() {
    // Create the reset trigger when the app is accessed
    createDailyResetTrigger();
    
    validateEnvironment();
    const template = HtmlService.createTemplateFromFile('Index');
    const initialData = getInitialDataHtml();
    template.initialData = initialData;
    return template.evaluate()
      .setTitle('ABSENSI LINE TOGEL')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
  }

  function validateEnvironment() {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const tz = spreadsheet.getSpreadsheetTimeZone();
    if (tz !== CONFIG.TIMEZONE) {
      console.warn(`Timezone spreadsheet (${tz}) tidak sesuai dengan konfigurasi (${CONFIG.TIMEZONE})`);
    }
    const scriptTz = Session.getScriptTimeZone();
    if (scriptTz !== CONFIG.TIMEZONE) {
      console.warn(`Timezone script (${scriptTz}) tidak sesuai dengan konfigurasi (${CONFIG.TIMEZONE})`);
    }
  }

  function getSheet() {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
    const waktuCol = CONFIG.COLUMNS.WAKTU;
    sheet.getRange(1, waktuCol, sheet.getMaxRows(), 1)
      .setNumberFormat(CONFIG.DATE_FORMAT);
    return sheet;
  }

  function getDataVersion() {
    const sheet = getSheet();
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();
    const dataRange = sheet.getRange(1, 1, lastRow, lastCol);
    const values = dataRange.getValues();
    
    let hash = 0;
    for (let i = 0; i < values.length; i++) {
      for (let j = 0; j < values[i].length; j++) {
        hash = ((hash << 5) - hash) + JSON.stringify(values[i][j]).length;
        hash = hash & hash;
      }
    }
    
    return {
      version: hash,
      lastUpdated: new Date().getTime()
    };
  }

  function getStaffData(clientVersion) {
    const currentVersion = getDataVersion().version;
    
    if (clientVersion && clientVersion === currentVersion) {
      return null;
    }
    
    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();
    let lastRowWithData = 0;
    
    for (let i = 1; i < data.length; i++) {
      if (!data[i][CONFIG.COLUMNS.ID - 1]) break;
      lastRowWithData = i;
    }
    
    const staffData = data.slice(1, lastRowWithData + 1).map(row => ({
      id: String(row[CONFIG.COLUMNS.ID - 1]).trim(),
      nama: row[CONFIG.COLUMNS.NAMA - 1] || '',
      jabatan: row[CONFIG.COLUMNS.JABATAN - 1] || '',
      status: row[CONFIG.COLUMNS.STATUS - 1] || 'Belum Absen',
      waktu: formatWaktu(row[CONFIG.COLUMNS.WAKTU - 1])
    }));
    
    return {
      data: staffData,
      version: currentVersion,
      lastUpdated: new Date().getTime()
    };
  }

  function getInitialDataHtml() {
    const staffData = getStaffData().data;
    const totalStaff = staffData.length;
    const presentCount = staffData.filter(staff => staff.status === 'Sudah Absen').length;
    const absentCount = totalStaff - presentCount;
    const tableRows = staffData.map(staff => {
      const waktuDisplay = staff.waktu === '-' ? '-' :
        Utilities.formatDate(new Date(staff.waktu), CONFIG.TIMEZONE, CONFIG.DATE_FORMAT);
      return `
      <tr>
        <td class="mobile-hidden">${staff.id}</td>
        <td>${staff.nama}</td>
        <td class="mobile-hidden">${staff.jabatan || '-'}</td>
        <td><span class="status ${staff.status === 'Sudah Absen' ? 'present' : 'absent'}">
          ${staff.status} <i class="fas ${staff.status === 'Sudah Absen' ? 'fa-check' : 'fa-clock'}"></i>
        </span></td>
        <td class="time-format">${waktuDisplay}</td>
      </tr>
      `;
    }).join('');

    const selectOptions = staffData.map(staff => {
      const highlight = staff.status === 'Belum Absen' ? 'style="color: #4caf50; font-weight: 500;"' : '';
      return `<option value="${staff.id}" ${highlight}>${staff.nama} (${staff.jabatan || 'Tanpa Jabatan'})</option>`;
    }).join('');

    return {
      tableRows: tableRows || '<tr><td colspan="5" style="text-align: center; color: var(--gray);"><i class="fas fa-info-circle"></i> Tidak ada data absensi</td></tr>',
      selectOptions: selectOptions || '<option value="">-- Tidak ada data staff --</option>',
      stats: { totalStaff, presentCount, absentCount }
    };
  }

  function getUpdatedStaffData(staffId) {
    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      const rowId = String(data[i][CONFIG.COLUMNS.ID - 1]).trim().toLowerCase();
      if (rowId === staffId.toLowerCase().trim()) {
        return {
          id: String(data[i][CONFIG.COLUMNS.ID - 1]).trim(),
          nama: data[i][CONFIG.COLUMNS.NAMA - 1] || '',
          jabatan: data[i][CONFIG.COLUMNS.JABATAN - 1] || '',
          status: data[i][CONFIG.COLUMNS.STATUS - 1] || 'Belum Absen',
          waktu: formatWaktu(data[i][CONFIG.COLUMNS.WAKTU - 1])
        };
      }
    }
    return null;
  }

  function formatWaktu(waktu) {
    if (!waktu) return '-';
    if (typeof waktu === 'number') {
      const date = new Date((waktu - 25569) * 86400 * 1000);
      return Utilities.formatDate(date, CONFIG.TIMEZONE, CONFIG.DATE_FORMAT);
    }
    if (typeof waktu === 'string') {
      if (/^\d{2}:\d{2}:\d{2}$/.test(waktu)) {
        return waktu;
      }
      try {
        const date = new Date(waktu);
        if (!isNaN(date.getTime())) {
          return Utilities.formatDate(date, CONFIG.TIMEZONE, CONFIG.DATE_FORMAT);
        }
      } catch(e) {
        console.error('Gagal parsing tanggal:', waktu, e);
      }
    }
    if (waktu instanceof Date) {
      return Utilities.formatDate(waktu, CONFIG.TIMEZONE, CONFIG.DATE_FORMAT);
    }
    return '-';
  }

  function markAttendance(staffId) {
    if (!staffId || typeof staffId !== 'string') {
      return { success: false, message: 'ID Staff tidak valid' };
    }

    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();
    let staffRow = null;
    let rowIndex = 0;
    for (let i = 1; i < data.length; i++) {
      const rowId = String(data[i][CONFIG.COLUMNS.ID - 1]).trim().toLowerCase();
      if (rowId === staffId.toLowerCase().trim()) {
        staffRow = data[i];
        rowIndex = i + 1;
        break;
      }
    }

    if (!staffRow) {
      return { success: false, message: 'Data staff tidak ditemukan' };
    }

    if (staffRow[CONFIG.COLUMNS.STATUS - 1] === 'Sudah Absen') {
      return {
        success: false,
        message: 'Anda sudah absen hari ini!',
        alreadyMarked: true
      };
    }

    Utilities.sleep(1000);
    const now = new Date();
    const waktuAbsen = Utilities.formatDate(now, CONFIG.TIMEZONE, CONFIG.DATE_FORMAT);
    
    sheet.getRange(rowIndex, CONFIG.COLUMNS.STATUS).setValue('Sudah Absen');
    const waktuRange = sheet.getRange(rowIndex, CONFIG.COLUMNS.WAKTU);
    waktuRange.clearContent();
    waktuRange.setValue(waktuAbsen);
    waktuRange.setNumberFormat(CONFIG.DATE_FORMAT);

    return {
      success: true,
      nama: staffRow[CONFIG.COLUMNS.NAMA - 1],
      jabatan: staffRow[CONFIG.COLUMNS.JABATAN - 1],
      waktu: waktuAbsen,
      message: 'Absen berhasil dicatat!'
    };
  }

  function createDailyResetTrigger() {
    // Delete any existing triggers to avoid duplicates
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'dailyReset') {
        ScriptApp.deleteTrigger(trigger);
      }
    });

    // Create new daily trigger
    const today = new Date();
    const resetTime = new Date(
      today.getFullYear(),
      today.getMonth(),
      today.getDate(),
      CONFIG.RESET_HOUR,
      0, 0, 0
    );
    
    // If it's already past reset time today, schedule for tomorrow
    if (today > resetTime) {
      resetTime.setDate(resetTime.getDate() + 1);
    }

    ScriptApp.newTrigger('dailyReset')
      .timeBased()
      .at(resetTime)
      .create();
    
    console.log('Daily reset trigger created for:', resetTime);
  }

  function dailyReset() {
    const sheet = getSheet();
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) return; // No data to reset
    
    // Reset STATUS column (column 4)
    const statusRange = sheet.getRange(2, CONFIG.COLUMNS.STATUS, lastRow - 1, 1);
    statusRange.setValue('Belum Absen');
    
    // Clear WAKTU column (column 5)
    const waktuRange = sheet.getRange(2, CONFIG.COLUMNS.WAKTU, lastRow - 1, 1);
    waktuRange.clearContent();
    
    // Recreate the trigger for the next day
    createDailyResetTrigger();
    
    console.log('Attendance data reset at:', new Date());
    
    // Optional: Add notification
    try {
      MailApp.sendEmail({
        to: Session.getEffectiveUser().getEmail(),
        subject: 'Reset Absensi Harian Berhasil',
        body: `Data absensi telah direset pada ${new Date()}.\n\nTotal data yang direset: ${lastRow - 1}`
      });
    } catch(e) {
      console.error('Gagal mengirim notifikasi email:', e);
    }
  }
  ?>
</body>
</html>
